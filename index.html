<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Aspirasi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    button {
      padding: 4px 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>üìã Data Aspirasi Warga</h2>
  <div id="notif"></div>
  <table id="tabelAspirasi">
    <thead>
      <tr>
        <th>No</th>
        <th>Tanggal</th>
        <th>Nama</th>
        <th>Pesan</th>
        <th>Foto/Video</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tabelBody"></tbody>
  </table>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKnY3Ny4kJZJjrgUbCnkr7WCv3HuvM0M-QdoMpQ_n7Uq1VncUXmCgcXYOPv8otYnbG/exec";

    async function muatData() {
      try {
        const res = await fetch(SCRIPT_URL);
        const json = await res.json();

        const data = json.data;
        const tabelBody = document.getElementById("tabelBody");
        tabelBody.innerHTML = "";

        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (!row[1]) continue;

          const tr = document.createElement("tr");
          const foto = row[3] 
            ? `<a href="${row[3]}" target="_blank">Lihat</a>` 
            : "-";
          const status = row[4] || "Baru";

          tr.innerHTML = `
            <td>${i}</td>
            <td>${row[0]}</td>
            <td>${row[1]}</td>
            <td>${row[2]}</td>
            <td>${foto}</td>
            <td>${status}</td>
            <td>
              <select onchange="ubahStatus(${i+1}, this.value)">
                <option value="Baru" ${status==="Baru"?"selected":""}>Baru</option>
                <option value="Diproses" ${status==="Diproses"?"selected":""}>Diproses</option>
                <option value="Selesai" ${status==="Selesai"?"selected":""}>Selesai</option>
              </select>
            </td>
          `;
          tabelBody.appendChild(tr);
        }

      } catch (err) {
        document.getElementById("notif").innerText = "‚ö†Ô∏è Gagal memuat data: " + err;
      }
    }

    async function ubahStatus(row, value) {
      try {
        const res = await fetch(SCRIPT_URL + "?action=update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ row: row, col: 5, value: value })
        });

        const result = await res.json();
        if (result.result === "success") {
          alert("‚úÖ Status berhasil diperbarui");
          muatData();
        } else {
          alert("‚ö†Ô∏è Gagal update: " + (result.message || "Tidak diketahui"));
        }
      } catch (err) {
        alert("‚ùå Gagal koneksi: " + err);
      }
    }

    muatData();
  </script>
</body>
</html>
