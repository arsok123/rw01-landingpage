<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Form Aspirasi (Kirim)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:16px;background:#f5f7fb}
  .card{max-width:640px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  input,textarea,button{width:100%;padding:10px;margin-top:8px;border-radius:6px;border:1px solid #d9e0ea;box-sizing:border-box}
  button{background:#2d89ef;color:#fff;border:none;font-weight:600;cursor:pointer}
  .preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:10px}
  .preview img,.preview video{width:100%;height:auto;border-radius:6px;border:1px solid #eee}
  .small{font-size:13px;color:#666;margin-top:8px}
  .notif{margin-top:10px;font-weight:600;text-align:center}
</style>
</head>
<body>
  <div class="card">
    <h2>üó£Ô∏è Kirim Aspirasi</h2>
    <form id="aspirasiForm">
      <input id="nama" name="nama" placeholder="Nama Anda" required />
      <textarea id="pesan" name="pesan" placeholder="Tulis aspirasi..." rows="4" required></textarea>

      <label class="small">Foto / Video (opsional)</label>
      <input id="fileInput" type="file" accept="image/*,video/*" />

      <div id="preview" class="preview"></div>

      <button type="submit">Kirim Aspirasi</button>
    </form>

    <div id="notif" class="notif"></div>
    <p class="small">Catatan: Foto/video akan diunggah ke Google Drive dan link otomatis disimpan di Google Sheets.</p>
  </div>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwjT5hTU_iENBjXLuzVmfqrIIG7--41laWnhyGliNuaWM5rf_2S11aL0gHXbvsUXzxR/exec";

const form = document.getElementById('aspirasiForm');
const notif = document.getElementById('notif');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');

let selectedFile = null;

// üîπ Preview file
fileInput.addEventListener('change', () => {
  preview.innerHTML = '';
  selectedFile = fileInput.files[0] || null;
  if (!selectedFile) return;
  const url = URL.createObjectURL(selectedFile);
  if (selectedFile.type.startsWith('image/')) {
    const img = document.createElement('img');
    img.src = url;
    preview.appendChild(img);
  } else {
    const vid = document.createElement('video');
    vid.src = url;
    vid.controls = true;
    preview.appendChild(vid);
  }
});

// üîπ Submit form
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  notif.style.color = "#000";
  notif.textContent = "‚è≥ Mengirim data...";

  const nama = document.getElementById('nama').value.trim();
  const pesan = document.getElementById('pesan').value.trim();
  if (!nama || !pesan) {
    notif.style.color = "red";
    notif.textContent = "‚ö†Ô∏è Harap isi nama dan pesan.";
    return;
  }

  let fileURL = "";
  if (selectedFile) {
    notif.textContent = "‚è≥ Mengunggah file ke Drive...";
    const base64 = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result).split(",")[1]);
      reader.onerror = reject;
      reader.readAsDataURL(selectedFile);
    });

    // Kirim file base64 ke Apps Script ‚Üí akan dikonversi ke file Drive
    const uploadRes = await fetch(ENDPOINT + "?action=upload", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        filename: selectedFile.name,
        file: base64,
        type: selectedFile.type
      })
    });

    const uploadJson = await uploadRes.json();
    if (uploadJson.fileUrl) {
      fileURL = uploadJson.fileUrl;
    }
  }

  // üî∏ Data dikirim ke Apps Script (array of rows)
  const rowData = [
    [new Date().toLocaleString("id-ID"), nama, pesan, fileURL, "Baru"]
  ];

  notif.textContent = "‚è≥ Menyimpan ke Google Sheets...";
  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(rowData)
    });
    const j = await res.json();

    if (res.ok && j.message && j.message.includes("Appended")) {
      notif.style.color = "green";
      notif.textContent = "‚úÖ Aspirasi berhasil dikirim!";
      form.reset();
      preview.innerHTML = "";
      selectedFile = null;
    } else {
      notif.style.color = "red";
      notif.textContent = "‚ùå Gagal kirim: " + (j.error || j.message || JSON.stringify(j));
      console.error(j);
    }
  } catch (err) {
    notif.style.color = "red";
    notif.textContent = "‚ùå Tidak dapat terhubung ke server.";
    console.error(err);
  }
});
</script>
</body>
</html>
