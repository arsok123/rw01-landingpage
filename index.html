<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Aspirasi Warga</title>
<style>
body { font-family: Arial; margin: 20px; background: #f8f9fa; }
h1 { text-align:center; color:#333; }
table { width:100%; border-collapse: collapse; margin-top:20px; background:white; }
th, td { border:1px solid #ddd; padding:10px; text-align:center; vertical-align:top; }
th { background:#007bff; color:white; }
img, video { max-width:120px; border-radius:8px; display:block; margin:4px auto; }
select, button { padding:5px; border-radius:5px; border:1px solid #ccc; }
button { background:#28a745; color:white; cursor:pointer; }
button:hover { background:#218838; }
.status-baru { background:#ffeeba; }
.status-proses { background:#bee5eb; }
.status-selesai { background:#c3e6cb; }
.filter-container { display:flex; gap:10px; justify-content:center; margin-bottom:10px; flex-wrap:wrap; }
</style>
</head>
<body>
<h1>üìã Dashboard Aspirasi Warga</h1>

<div class="filter-container">
  <label>Status:</label>
  <select id="filterStatus">
    <option value="">Semua</option>
    <option value="Baru">Baru</option>
    <option value="Proses">Proses</option>
    <option value="Selesai">Selesai</option>
  </select>

  <label>Dari:</label>
  <input type="date" id="filterDari">

  <label>Sampai:</label>
  <input type="date" id="filterSampai">

  <button onclick="terapkanFilter()">üîç Filter</button>
  <button onclick="resetFilter()" style="background:#6c757d">üîÑ Reset</button>
</div>

<table>
  <thead>
    <tr>
      <th>Tanggal</th>
      <th>Nama</th>
      <th>Pesan</th>
      <th>File / Foto / Video</th>
      <th>Status</th>
      <th>Ubah Status</th>
    </tr>
  </thead>
  <tbody id="tabelBody"></tbody>
</table>

<script>
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwBBD7MhPZjtlTLHoWT1X0SZqprxVN367l2ZSfVGjugoHGYhEJI680tqVgSNpw1ZUaUlg/exec";
let semuaData = [];

async function muatData() {
  try {
    const res = await fetch(ENDPOINT);
    const json = await res.json();
    semuaData = json.data.slice(1); // skip header
    tampilkanData(semuaData);
  } catch(err) {
    alert("Gagal memuat data: " + err);
  }
}

function konversiLinkDrive(url) {
  if (!url) return [];
  const parts = url.split(',').map(u=>u.trim()).filter(Boolean);
  return parts.map(u=>{
    const match = u.match(/[-\w]{25,}/);
    return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : u;
  });
}

function tampilkanData(data) {
  const tabel = document.getElementById("tabelBody");
  tabel.innerHTML = "";
  data.forEach((row,i) => {
    if (!row[0]) return;
    const [tanggal,nama,pesan,fileUrl,status] = row;
    const tgl = new Date(tanggal);
    const statusClass =
      status==="Selesai" ? "status-selesai" :
      status==="Proses" ? "status-proses" :
      "status-baru";

    const fileLinks = konversiLinkDrive(fileUrl);
    let fileHTML = "<em>Tidak ada</em>";
    if (fileLinks.length) {
      fileHTML = fileLinks.map(link=>{
        if (link.match(/\.(mp4|webm|ogg)$/i)) {
          return `<video src="${link}" controls></video>`;
        } else {
          return `<a href="${link}" target="_blank"><img src="${link}"></a>`;
        }
      }).join("");
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${tgl.toLocaleString()}</td>
      <td>${nama}</td>
      <td>${pesan}</td>
      <td>${fileHTML}</td>
      <td class="${statusClass}">${status}</td>
      <td>
        <select id="status${i}">
          <option value="Baru" ${status==="Baru"?"selected":""}>Baru</option>
          <option value="Proses" ${status==="Proses"?"selected":""}>Proses</option>
          <option value="Selesai" ${status==="Selesai"?"selected":""}>Selesai</option>
        </select>
        <button onclick="ubahStatus(${i+2})">Simpan</button>
      </td>
    `;
    tabel.appendChild(tr);
  });
}

function terapkanFilter() {
  const status = document.getElementById("filterStatus").value;
  const dari = document.getElementById("filterDari").value ? new Date(document.getElementById("filterDari").value) : null;
  const sampai = document.getElementById("filterSampai").value ? new Date(document.getElementById("filterSampai").value) : null;

  const hasil = semuaData.filter(row => {
    const [tanggal,, , ,stat] = row;
    const tgl = new Date(tanggal);
    if (status && stat!==status) return false;
    if (dari && tgl<dari) return false;
    if (sampai && tgl>sampai) return false;
    return true;
  });
  tampilkanData(hasil);
}

function resetFilter() {
  document.getElementById("filterStatus").value="";
  document.getElementById("filterDari").value="";
  document.getElementById("filterSampai").value="";
  tampilkanData(semuaData);
}

async function ubahStatus(row) {
  const idx = row-2;
  const val = document.getElementById(`status${idx}`).value;
  try {
    const res = await fetch(ENDPOINT+"?action=update&row="+row+"&col=5&value="+encodeURIComponent(val));
    const json = await res.json();
    if(json.result==="success") {
      alert("‚úÖ Status berhasil diperbarui!");
      muatData();
    } else {
      alert("‚ö†Ô∏è Gagal update status!\n"+JSON.stringify(json));
    }
  } catch(err) {
    alert("‚ùå Gagal koneksi: " + err.message);
  }
}

muatData();
</script>
</body>
</html>
